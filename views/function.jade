extends layout

block content
  script(src="/javascripts/ethers-5.1.umd.min.js")
  script(src="https://code.jquery.com/jquery-3.6.0.min.js")
  script.
    const args1 = !{JSON.stringify(fun.inputs)}

    async function wrappedRun() {
      try {
        if(typeof window.ethereum === "undefined"){
          alert("Please install Metamask");
          window.location.href = "https://metamask.io";
        }
        window.ethereum.enable();
        await run();
      } catch(e){
        $("#response").val(e.toString());
      }
    }

    async function run() {
      try{
        const args2 = args1.map(a => $("#"+a.name).val());
        if("#{fun.stateMutability}" === "pure" || "#{fun.stateMutability}" === "view" || "#{fun.stateMutability}" !== "payable"){
          $("#response").html("Transaction Pending...");
          const response = await contract["#{fun.name}"](...args2);
          console.log(response);
          $("#response").html(JSON.stringify(response));
        }
        else {
          //payable
          $("#response").html("Transaction Pending...");
          const response = await contract["#{fun.name}"](...args2, { value: ethers.utils.parseEther($("#value").val()) });
          const txReceipt = await response.wait();
          console.log(txReceipt);
          $("#response").html("Transaction successful \n\n"+JSON.stringify(txReceipt));
        }
      }
      catch(e){
        console.log(e, e.toString());
        $("#response").html(e.toString());
      }
    }


  .container
    h1= fun.name.replace( /([A-Z])/g, " $1" )
    a(href="/"+address+"?abi="+abiEncoded+"&network="+network) #[i(data="close")] Back to all functions
    include ./walletSetup
    .inputContainer
      each inp in fun.inputs 
        .card
          h3= inp.name.replace( /([A-Z])/g, " $1" )
          input(placeholder=inp.name.replace( /([A-Z])/g, " $1" )+"("+fun.type+")" id=inp.name)

      if fun.stateMutability === "payable"
        .card 
          h3 This function expects a payment
          input(placeholder="Amount to send in Ethers" id="value")
      .card
        h3 Execute Transaction
        button( onclick="wrappedRun()") Run
        br
        br
        pre(id="response").
          Fill in the parameters and tap run

